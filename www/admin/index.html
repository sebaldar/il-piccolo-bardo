<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Il Piccolo Bardo - Database Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            text-align: center;
        }

        h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 1.1em;
        }

        .connection-status {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: bold;
            margin-top: 15px;
            font-size: 0.9em;
        }

        .connection-status.connected {
            background: #4caf50;
            color: white;
        }

        .connection-status.disconnected {
            background: #f44336;
            color: white;
        }

        .connection-status.connecting {
            background: #ff9800;
            color: white;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 150px;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-success {
            background: #4caf50;
            color: white;
        }

        .btn-info {
            background: #2196f3;
            color: white;
        }

        .btn-warning {
            background: #ff9800;
            color: white;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 600;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .log-container {
            background: #1e1e1e;
            color: #0f0;
            padding: 20px;
            border-radius: 10px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .log-entry {
            margin-bottom: 8px;
            padding: 5px;
            border-left: 3px solid #0f0;
            padding-left: 10px;
        }

        .log-entry.error {
            color: #f44336;
            border-left-color: #f44336;
        }

        .log-entry.success {
            color: #4caf50;
            border-left-color: #4caf50;
        }

        .log-entry.info {
            color: #2196f3;
            border-left-color: #2196f3;
        }

        .main-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .main-tab {
            padding: 15px 30px;
            background: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 700;
            font-size: 1.1em;
            color: #666;
            transition: all 0.3s;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .main-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .main-tab-content {
            display: none;
        }

        .main-tab-content.active {
            display: block;
        }

        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
        }

        .tab {
            padding: 12px 24px;
            background: #f5f5f5;
            border: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }

        .tab.active {
            background: #667eea;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .multi-select-box {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            background: #f9f9f9;
        }

        .multi-select-item {
            padding: 15px;
            margin-bottom: 8px;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid #e0e0e0;
        }

        .multi-select-item:hover {
            background: #f8f9ff;
            border-color: #667eea;
        }

        .multi-select-item.selected {
            background: #e3f2fd;
            border-color: #667eea;
        }

        .multi-select-item input[type="checkbox"] {
            width: auto;
            cursor: pointer;
        }

        .story-preview {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .story-preview h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .preview-section {
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border-radius: 6px;
        }

        .preview-section strong {
            color: #667eea;
            display: block;
            margin-bottom: 5px;
        }

        .story-card {
            background: white;
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }

        .story-card:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }

        .story-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            cursor: pointer;
        }

        .story-card-title {
            font-size: 1.3em;
            color: #667eea;
            font-weight: 700;
        }

        .story-card-details {
            display: none;
            padding-top: 15px;
            border-top: 2px solid #f0f0f0;
        }

        .story-card-details.expanded {
            display: block;
        }

        .detail-section {
            margin-bottom: 15px;
        }

        .detail-section h4 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .detail-item {
            background: #f9f9f9;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 8px;
            border-left: 3px solid #667eea;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
            margin-right: 5px;
        }

        .badge-age {
            background: #e3f2fd;
            color: #1976d2;
        }

        .badge-complexity {
            background: #fff3e0;
            color: #f57c00;
        }

        .badge-role {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 15px;
        }

        .order-input {
            width: 60px !important;
            display: inline-block;
            margin-left: 10px;
        }

        .refresh-btn {
            float: right;
            min-width: auto;
            padding: 8px 16px;
        }

        .fragment-setting-select {
            width: 100% !important;
            margin-top: 8px;
            font-size: 0.9em;
            padding: 8px;
            border: 2px solid #ddd;
            background: white;
        }

        .fragment-item-header {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            width: 100%;
        }

        .fragment-item-content {
            flex: 1;
        }

        .fragment-controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-width: 80px;
        }

        .fragment-settings-row {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #ddd;
        }

        .fragment-settings-label {
            font-size: 0.85em;
            color: #667eea;
            font-weight: 600;
            margin-bottom: 5px;
            display: block;
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .main-tabs {
                flex-direction: column;
            }
            
            .main-tab {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üé≠ Il Piccolo Bardo</h1>
            <p class="subtitle">Database Manager - Sistema di Gestione Storie</p>
            <div class="connection-status" id="connectionStatus">Disconnesso</div>
        </header>

        <!-- Main Navigation Tabs -->
        <div class="main-tabs">
            <button class="main-tab active" onclick="switchMainTab('database', this)">‚öôÔ∏è Database</button>
            <button class="main-tab" onclick="switchMainTab('nodes', this)">üìù Crea Nodi</button>
            <button class="main-tab" onclick="switchMainTab('builder', this)">üèóÔ∏è Costruisci Storia</button>
            <button class="main-tab" onclick="switchMainTab('visualize', this)">üëÅÔ∏è Visualizza Storie</button>
            <button class="main-tab" onclick="switchMainTab('import', this)">üì• Importa Repertorio</button>
            <button class="main-tab" onclick="switchMainTab('generate', this)">ü™Ñ Raccontami una storia!</button>
        </div>

        <!-- TAB 1: DATABASE OPERATIONS -->
        <div id="database-content" class="main-tab-content active">
            <div class="main-grid">
                <div class="card">
                    <h2>‚öôÔ∏è Operazioni Database</h2>
                    <div class="button-group">
                        <button class="btn-success" onclick="initDatabase()">Inizializza DB</button>
                        <button class="btn-danger" onclick="clearDatabase()">Cancella DB</button>
                    </div>
                </div>

                <div class="card">
                    <h2>üìä Statistiche</h2>
                    <div class="button-group">
                        <button class="btn-info" onclick="getStats()">Aggiorna</button>
                    </div>
                    <div id="statsDisplay" style="margin-top: 15px; color: #666;"></div>
                </div>
            </div>
        </div>

        <!-- TAB 2: CREATE NODES -->
        <div id="nodes-content" class="main-tab-content">
            <div class="card">
                <h2>üìù Creazione Nodi Base</h2>
                
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('story')">Storia</button>
                    <button class="tab" onclick="switchTab('fragment')">Frammento</button>
                    <button class="tab" onclick="switchTab('character')">Personaggio</button>
                    <button class="tab" onclick="switchTab('setting')">Ambientazione</button>
                </div>

                <!-- Story Form -->
                <div id="story-tab" class="tab-content active">
                    <div class="form-group">
                        <label>ID Storia</label>
                        <input type="text" id="storyId" placeholder="es: story_001">
                    </div>
                    <div class="form-group">
                        <label>Titolo</label>
                        <input type="text" id="storyTitle" placeholder="Il coraggio del cagnolino">
                    </div>
                    <div class="form-group">
                        <label>Descrizione</label>
                        <textarea id="storyDescription" placeholder="Una storia sul superare le paure..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Et√† Minima</label>
                        <input type="number" id="storyAgeMin" value="3" min="2" max="6">
                    </div>
                    <div class="form-group">
                        <label>Et√† Massima</label>
                        <input type="number" id="storyAgeMax" value="5" min="2" max="6">
                    </div>
                    <button class="btn-success" onclick="createStory()">Crea Storia</button>
                </div>

                <!-- Fragment Form -->
                <div id="fragment-tab" class="tab-content">
                    <div class="form-group">
                        <label>ID Frammento</label>
                        <input type="text" id="fragmentId" placeholder="es: pf_001">
                    </div>
                    <div class="form-group">
                        <label>Testo del Frammento</label>
                        <textarea id="fragmentText" placeholder="Il cagnolino guard√≤ avanti e fece un piccolo passo..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Et√† Minima</label>
                        <input type="number" id="fragmentAgeMin" value="3" min="2" max="6">
                    </div>
                    <div class="form-group">
                        <label>Et√† Massima</label>
                        <input type="number" id="fragmentAgeMax" value="5" min="2" max="6">
                    </div>
                    <div class="form-group">
                        <label>Complessit√†</label>
                        <select id="fragmentComplexity">
                            <option value="bassa">Bassa</option>
                            <option value="media">Media</option>
                            <option value="alta">Alta</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Tono</label>
                        <select id="fragmentTone">
                            <option value="positivo">Positivo</option>
                            <option value="neutro">Neutro</option>
                            <option value="riflessivo">Riflessivo</option>
                        </select>
                    </div>
                    <button class="btn-success" onclick="createFragment()">Crea Frammento</button>
                </div>

                <!-- Character Form -->
                <div id="character-tab" class="tab-content">
                    <div class="form-group">
                        <label>ID Personaggio</label>
                        <input type="text" id="charId" placeholder="es: ch_dog">
                    </div>
                    <div class="form-group">
                        <label>Nome</label>
                        <input type="text" id="charName" placeholder="Cagnolino">
                    </div>
                    <div class="form-group">
                        <label>Descrizione</label>
                        <textarea id="charDescription" placeholder="Un piccolo cagnolino coraggioso..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Tratti (uno per riga)</label>
                        <textarea id="charTraits" placeholder="timido&#10;curioso&#10;coraggioso"></textarea>
                    </div>
                    <button class="btn-success" onclick="createCharacter()">Crea Personaggio</button>
                </div>

                <!-- Setting Form -->
                <div id="setting-tab" class="tab-content">
                    <div class="form-group">
                        <label>ID Ambientazione</label>
                        <input type="text" id="settingId" placeholder="es: st_forest">
                    </div>
                    <div class="form-group">
                        <label>Nome</label>
                        <input type="text" id="settingName" placeholder="Bosco Incantato">
                    </div>
                    <div class="form-group">
                        <label>Tipo</label>
                        <select id="settingType">
                            <option value="naturale">Naturale</option>
                            <option value="urbano">Urbano</option>
                            <option value="fantastico">Fantastico</option>
                            <option value="domestico">Domestico</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Descrizione</label>
                        <textarea id="settingDescription" placeholder="Un bosco magico pieno di meraviglie..."></textarea>
                    </div>
                    <button class="btn-success" onclick="createSetting()">Crea Ambientazione</button>
                </div>
            </div>
        </div>

        <!-- TAB 3: STORY BUILDER -->
        <div id="builder-content" class="main-tab-content">
            <div class="card">
                <h2>üèóÔ∏è Costruttore di Storie</h2>
                <button class="btn-info refresh-btn" onclick="loadBuilderData()">üîÑ Aggiorna</button>
                
                <div class="form-group" style="margin-top: 50px;">
                    <label>Seleziona Storia Base</label>
                    <select id="builderStorySelect" onchange="updateBuilderPreview()">
                        <option value="">-- Seleziona una storia --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>üìÑ Seleziona Frammenti</label>
                    <p style="font-size: 0.9em; color: #666; margin-bottom: 10px;">
                        Per ogni frammento puoi specificare: <strong>Ordine</strong> (sequenza nel racconto) e <strong>Ambientazione</strong> (dove avviene la scena)
                    </p>
                    <div id="builderFragments" class="multi-select-box"></div>
                </div>

                <div class="form-group">
                    <label>üë§ Seleziona Personaggi</label>
                    <div id="builderCharacters" class="multi-select-box"></div>
                </div>

                <div class="form-group">
                    <label>üèûÔ∏è Ambientazioni Generali della Storia (multiple)</label>
                    <p style="font-size: 0.9em; color: #666; margin-bottom: 10px;">
                        Seleziona le ambientazioni che compaiono nella storia. Puoi poi assegnare ambientazioni specifiche a ciascun frammento sopra.
                    </p>
                    <div id="builderSettings" class="multi-select-box"></div>
                </div>

                <div class="form-group">
                    <label>üé≠ Emozioni da Associare ai Frammenti (separate da virgola)</label>
                    <input type="text" id="builderEmotions" placeholder="coraggio, gioia, curiosit√†">
                </div>

                <div class="form-group">
                    <label>üí° Temi da Associare ai Frammenti (separati da virgola)</label>
                    <input type="text" id="builderThemes" placeholder="autostima, amicizia, crescita">
                </div>

                <div class="story-preview" id="builderPreview">
                    <h3>üìã Anteprima Storia</h3>
                    <p style="color: #999;">Seleziona una storia per vedere l'anteprima...</p>
                </div>

                <div class="button-group" style="margin-top: 20px;">
                    <button class="btn-success" onclick="buildStory()">‚ú® Costruisci Storia Completa</button>
                    <button class="btn-warning" onclick="resetBuilder()">üîÑ Reset</button>
                </div>
            </div>
        </div>

        <!-- TAB 4: VISUALIZE STORIES -->
        <div id="visualize-content" class="main-tab-content">
            <div class="card">
                <h2>üëÅÔ∏è Visualizza Storie</h2>
                <button class="btn-info refresh-btn" onclick="loadStories()">üîÑ Aggiorna</button>
                
                <div id="storiesList"></div>
            </div>
        </div>
        <!-- TAB 4: IMPORT -->

<div id="import-content" class="main-tab-content">
  <div class="card">
    <h2>üì• Importa Repertorio Completo</h2>
    <p style="margin-bottom: 20px; color: #666;">
      Carica un file JSON con storie, frammenti, personaggi, ambientazioni e collegamenti.<br>
      Utile per popolare rapidamente il database con un repertorio iniziale.
    </p>

    <div class="form-group">
      <label>Scegli file JSON</label>
      <input type="file" id="importFile" accept=".json" />
    </div>

    <div class="button-group">
      <button class="btn-success" onclick="importRepertoire()">üöÄ Importa Tutto</button>
      <button class="btn-warning" onclick="document.getElementById('importFile').value=''">üîÑ Annulla</button>
    </div>

    <div id="importLog" class="log-container" style="margin-top: 20px; display: none;"></div>
  </div>
</div>

<!-- TAB 5: GENERA STORIA CON AI -->
<div id="generate-content" class="main-tab-content">
  <div class="card">
    <h2>ü™Ñ Raccontami una storia!</h2>
    <p style="margin-bottom: 20px; color: #666; font-size: 1.1em;">
      Dimmi cosa vuoi nella favola e Il Piccolo Bardo la creer√† apposta per te, ispirandosi al suo repertorio magico.
    </p>

    <div class="form-group">
      <label>üìÖ Et√† del bambino</label>
      <select id="genAge" style="width: 200px;">
        <option value="3">3 anni</option>
        <option value="4">4 anni</option>
        <option value="5" selected>5 anni</option>
        <option value="6">6 anni</option>
        <option value="7">7 anni</option>
      </select>
    </div>

    <div class="form-group">
      <label>üí≠ Di cosa vuoi che parli la storia?</label>
      <textarea id="genPrompt" rows="5" placeholder="Esempi:
- un drago gentile che ha paura del buio
- una principessa coraggiosa che salva un amico
- tre animaletti che costruiscono una casa insieme
- un gattino che impara a volare con le farfalle"></textarea>
    </div>

    <div class="button-group">
      <button class="btn-success" id="generateBtn" onclick="generateStory()">‚ú® Crea la mia favola!</button>
      <button class="btn-warning" onclick="resetGenerateTab()">üîÑ Nuova idea</button>
    </div>

    <div class="story-preview" id="generatedStory" style="margin-top: 30px;">
      <p style="color: #999; text-align: center; font-style: italic;">
        Scrivi la tua idea e premi "Crea la mia favola"...
      </p>
    </div>
  </div>
</div>


        <!-- Log -->
        <div class="card" style="margin-top: 20px;">
            <h2>üìã Log Operazioni</h2>
            <div class="log-container" id="logContainer"></div>
        </div>
    </div>

    <script>
        let ws = null;
        let reconnectInterval = null;
        let availableStories = [];
        let availableFragments = [];
        let availableCharacters = [];
        let availableSettings = [];
        let selectedFragments = [];
        let selectedCharacters = [];
        let selectedSettings = [];

        function connect() {
            updateStatus('connecting');
            addLog('Connessione a wss://www.ilpiccolobardo.it...', 'info');
            
            ws = new WebSocket('wss://www.ilpiccolobardo.it/ws');
            
            ws.onopen = () => {
                updateStatus('connected');
                addLog('‚úì Connesso al server!', 'success');
                if (reconnectInterval) {
                    clearInterval(reconnectInterval);
                    reconnectInterval = null;
                }
            };
            
            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    handleResponse(data);
                } catch (e) {
                    addLog('Errore parsing risposta: ' + e.message, 'error');
                }
            };
            
            ws.onerror = (error) => {
                addLog('Errore WebSocket', 'error');
            };
            
            ws.onclose = () => {
                updateStatus('disconnected');
                addLog('‚úó Connessione chiusa. Tentativo di riconnessione...', 'error');
                if (!reconnectInterval) {
                    reconnectInterval = setInterval(() => {
                        if (ws.readyState === WebSocket.CLOSED) {
                            connect();
                        }
                    }, 5000);
                }
            };
        }

        function sendMessage(action, data = {}) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                const message = {
                    pagina: "IL_PICCOLO_BARDO",
                    action: action,
                    data: data
                };
                ws.send(JSON.stringify(message));
                addLog(`‚Üí Inviato: ${action}`, 'info');
            } else {
                addLog('‚úó WebSocket non connesso!', 'error');
            }
        }

function handleResponse(response) {
    addLog(`‚Üê ${response.action || 'risposta'}`, 'success');
    
    if (response.action === 'stats') {
        displayStats(response.data);
    } else if (response.action === 'list_stories') {
        availableStories = response.data || [];
        updateBuilderStorySelect();
        displayStoriesList(response.data);
    } else if (response.action === 'list_fragments') {
        availableFragments = response.data || [];
        updateBuilderFragments();
    } else if (response.action === 'list_characters') {
        availableCharacters = response.data || [];
        updateBuilderCharacters();
    } else if (response.action === 'list_settings') {
        availableSettings = response.data || [];
        updateBuilderSettings();
    } else if (response.action === 'story_complete') {
        displayStoryDetails(response.data);
    } 
    // ‚Üê QUI AGGIUNGI IL NUOVO BLOCCO
    else if (response.action === 'generated_story') {
        const container = document.getElementById('generatedStory');
        const story = response.data.story;
        const inspirationCount = response.data.inspiration?.length || 0;

        container.innerHTML = `
          <h3 style="color:#667eea; text-align:center; margin-bottom:20px;">üìñ La tua favola personalizzata</h3>
          <div style="background:white; padding:30px; border-radius:15px; line-height:1.8; font-size:1.1em; box-shadow:0 5px 20px rgba(0,0,0,0.1);">
            ${story.replace(/\n/g, '<br><br>')}
          </div>
          <p style="margin-top:25px; text-align:center; color:#666; font-style:italic;">
            ‚ú® Ispirata a ${inspirationCount} frammenti del repertorio del Piccolo Bardo
          </p>
        `;

        addLog('Favola generata con successo!', 'success');

        // Riabilita il bottone
        const button = document.getElementById('generateBtn');
        if (button) {
            button.disabled = false;
            button.innerHTML = '‚ú® Crea un\'altra favola!';
        }
    }
}

        function updateStatus(status) {
            const statusEl = document.getElementById('connectionStatus');
            statusEl.className = `connection-status ${status}`;
            statusEl.textContent = status === 'connected' ? 'üü¢ Connesso' : 
                                  status === 'connecting' ? 'üü° Connessione...' : 
                                  'üî¥ Disconnesso';
        }

        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const timestamp = new Date().toLocaleTimeString('it-IT');
            entry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

function switchMainTab(tabName, element) {
  document.querySelectorAll('.main-tab').forEach(tab => tab.classList.remove('active'));
  document.querySelectorAll('.main-tab-content').forEach(content => content.classList.remove('active'));
  
  if (element) {
    element.classList.add('active');
  }
  document.getElementById(`${tabName}-content`).classList.add('active');
  
  if (tabName === 'builder') {
    loadBuilderData();
  } else if (tabName === 'visualize') {
    loadStories();
  } else if (tabName === 'generate') {
    document.getElementById('genPrompt').focus();
  }
}

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }

        function initDatabase() {
            if (confirm('Sei sicuro di voler inizializzare il database?')) {
                sendMessage('init_database');
            }
        }

        function clearDatabase() {
            if (confirm('ATTENZIONE: Questa operazione canceller√† TUTTI i dati!')) {
                sendMessage('clear_database');
            }
        }

        function getStats() {
            sendMessage('get_stats');
        }

        function displayStats(stats) {
            const display = document.getElementById('statsDisplay');
            display.innerHTML = `
                <p><strong>Storie:</strong> ${stats.stories || 0}</p>
                <p><strong>Frammenti:</strong> ${stats.fragments || 0}</p>
                <p><strong>Personaggi:</strong> ${stats.characters || 0}</p>
                <p><strong>Ambientazioni:</strong> ${stats.settings || 0}</p>
            `;
        }

        function createStory() {
            const data = {
                id: document.getElementById('storyId').value,
                title: document.getElementById('storyTitle').value,
                description: document.getElementById('storyDescription').value,
                ageMin: parseInt(document.getElementById('storyAgeMin').value),
                ageMax: parseInt(document.getElementById('storyAgeMax').value)
            };
            
            if (!data.id || !data.title) {
                addLog('ID e Titolo sono obbligatori!', 'error');
                return;
            }
            
            sendMessage('create_story', data);
        }

        function createFragment() {
            const data = {
                id: document.getElementById('fragmentId').value,
                text: document.getElementById('fragmentText').value,
                ageMin: parseInt(document.getElementById('fragmentAgeMin').value),
                ageMax: parseInt(document.getElementById('fragmentAgeMax').value),
                complexity: document.getElementById('fragmentComplexity').value,
                tone: document.getElementById('fragmentTone').value,
                embedding: []
            };
            
            if (!data.id || !data.text) {
                addLog('ID e Testo sono obbligatori!', 'error');
                return;
            }
            
            sendMessage('create_fragment', data);
        }

        function createCharacter() {
            const traits = document.getElementById('charTraits').value
                .split('\n')
                .map(t => t.trim())
                .filter(t => t);
            
            const data = {
                id: document.getElementById('charId').value,
                name: document.getElementById('charName').value,
                description: document.getElementById('charDescription').value,
                traits: traits
            };
            
            if (!data.id || !data.name) {
                addLog('ID e Nome sono obbligatori!', 'error');
                return;
            }
            
            sendMessage('create_character', data);
        }

        function createSetting() {
            const data = {
                id: document.getElementById('settingId').value,
                name: document.getElementById('settingName').value,
                type: document.getElementById('settingType').value,
                description: document.getElementById('settingDescription').value
            };
            
            if (!data.id || !data.name) {
                addLog('ID e Nome sono obbligatori!', 'error');
                return;
            }
            
            sendMessage('create_setting', data);
        }

        // STORY BUILDER FUNCTIONS
        function loadBuilderData() {
            sendMessage('list_stories');
            sendMessage('list_fragments');
            sendMessage('list_characters');
            sendMessage('list_settings');
            addLog('Caricamento dati per Story Builder...', 'info');
        }

        function updateBuilderStorySelect() {
            const select = document.getElementById('builderStorySelect');
            select.innerHTML = '<option value="">-- Seleziona una storia --</option>';
            availableStories.forEach(story => {
                const option = document.createElement('option');
                option.value = story.id;
                option.textContent = `${story.title} (${story.id})`;
                select.appendChild(option);
            });
        }

        function updateBuilderFragments() {
            const container = document.getElementById('builderFragments');
            if (availableFragments.length === 0) {
                container.innerHTML = '<p style="color: #999; text-align: center;">Nessun frammento disponibile</p>';
                return;
            }
            
            container.innerHTML = '';
            availableFragments.forEach((fragment, index) => {
                const item = document.createElement('div');
                item.className = 'multi-select-item';
                item.innerHTML = `
                    <div class="fragment-item-header">
                        <input type="checkbox" id="frag_${fragment.id}" onchange="toggleFragment('${fragment.id}')" style="margin-top: 5px;">
                        <div class="fragment-item-content">
                            <label for="frag_${fragment.id}" style="cursor: pointer; margin: 0;">
                                <strong>${fragment.id}</strong>
                                <span class="badge badge-complexity">${fragment.complexity}</span><br>
                                <span style="font-size: 0.9em; color: #666;">${fragment.text.substring(0, 80)}...</span>
                            </label>
                        </div>
                        <div class="fragment-controls">
                            <div>
                                <small style="display: block; color: #666; margin-bottom: 3px;">Ordine:</small>
                                <input type="number" class="order-input" id="order_${fragment.id}" placeholder="#" min="0" value="${index}" title="Ordine nel racconto">
                            </div>
                        </div>
                    </div>
                    <div class="fragment-settings-row" id="settings_row_${fragment.id}" style="display: none;">
                        <label class="fragment-settings-label">üìç Dove avviene questa scena?</label>
                        <select class="fragment-setting-select" id="setting_${fragment.id}" onchange="updateBuilderPreview()">
                            <option value="">-- Nessuna ambientazione specifica --</option>
                        </select>
                    </div>
                `;
                container.appendChild(item);
            });
            
            // Popola i dropdown delle ambientazioni per i frammenti
            updateFragmentSettingSelects();
        }

        function updateBuilderCharacters() {
            const container = document.getElementById('builderCharacters');
            if (availableCharacters.length === 0) {
                container.innerHTML = '<p style="color: #999; text-align: center;">Nessun personaggio disponibile</p>';
                return;
            }
            
            container.innerHTML = '';
            availableCharacters.forEach(char => {
                const item = document.createElement('div');
                item.className = 'multi-select-item';
                item.innerHTML = `
                    <input type="checkbox" id="char_${char.id}" onchange="toggleCharacter('${char.id}')">
                    <label for="char_${char.id}" style="flex: 1; cursor: pointer; margin: 0;">
                        <strong>${char.name}</strong> (${char.id})<br>
                        <span style="font-size: 0.9em;">${char.description || ''}</span>
                    </label>
                    <input type="text" style="width: 120px;" id="role_${char.id}" placeholder="Ruolo" value="protagonista">
                `;
                container.appendChild(item);
            });
        }

        function updateBuilderSettings() {
            const container = document.getElementById('builderSettings');
            if (availableSettings.length === 0) {
                container.innerHTML = '<p style="color: #999; text-align: center;">Nessuna ambientazione disponibile</p>';
                return;
            }
            
            container.innerHTML = '';
            availableSettings.forEach((setting, index) => {
                const item = document.createElement('div');
                item.className = 'multi-select-item';
                item.innerHTML = `
                    <input type="checkbox" id="set_${setting.id}" onchange="toggleSetting('${setting.id}')">
                    <label for="set_${setting.id}" style="flex: 1; cursor: pointer; margin: 0;">
                        <strong>${setting.name}</strong> (${setting.type})<br>
                        <span style="font-size: 0.9em;">${setting.description || ''}</span>
                    </label>
                    <input type="number" class="order-input" id="order_set_${setting.id}" placeholder="Ordine" min="0" value="${index}">
                `;
                container.appendChild(item);
            });
            
            // Aggiorna anche i dropdown dei frammenti
            updateFragmentSettingSelects();
        }

        function updateFragmentSettingSelects() {
            // Popola tutti i dropdown delle ambientazioni nei frammenti
            availableFragments.forEach(fragment => {
                const select = document.getElementById(`setting_${fragment.id}`);
                if (select) {
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">-- Nessuna ambientazione specifica --</option>';
                    
                    if (availableSettings.length === 0) {
                        const option = document.createElement('option');
                        option.value = '';
                        option.textContent = '‚ö†Ô∏è Crea prima delle ambientazioni';
                        option.disabled = true;
                        select.appendChild(option);
                    } else {
                        availableSettings.forEach(setting => {
                            const option = document.createElement('option');
                            option.value = setting.id;
                            option.textContent = `üìç ${setting.name} (${setting.type})`;
                            select.appendChild(option);
                        });
                    }
                    
                    select.value = currentValue;
                }
            });
        }

        function toggleFragment(fragmentId) {
            const checkbox = document.getElementById(`frag_${fragmentId}`);
            const item = checkbox.closest('.multi-select-item');
            const settingsRow = document.getElementById(`settings_row_${fragmentId}`);
            
            if (checkbox.checked) {
                selectedFragments.push(fragmentId);
                item.classList.add('selected');
                if (settingsRow) settingsRow.style.display = 'block';
            } else {
                selectedFragments = selectedFragments.filter(id => id !== fragmentId);
                item.classList.remove('selected');
                if (settingsRow) settingsRow.style.display = 'none';
            }
            updateBuilderPreview();
        }

        function toggleSetting(settingId) {
            const checkbox = document.getElementById(`set_${settingId}`);
            const item = checkbox.closest('.multi-select-item');
            
            if (checkbox.checked) {
                selectedSettings.push(settingId);
                item.classList.add('selected');
            } else {
                selectedSettings = selectedSettings.filter(id => id !== settingId);
                item.classList.remove('selected');
            }
            updateBuilderPreview();
        }

        function toggleCharacter(characterId) {
            const checkbox = document.getElementById(`char_${characterId}`);
            const item = checkbox.closest('.multi-select-item');
            
            if (checkbox.checked) {
                selectedCharacters.push(characterId);
                item.classList.add('selected');
            } else {
                selectedCharacters = selectedCharacters.filter(id => id !== characterId);
                item.classList.remove('selected');
            }
            updateBuilderPreview();
        }

        function updateBuilderPreview() {
            const storyId = document.getElementById('builderStorySelect').value;
            const preview = document.getElementById('builderPreview');
            
            if (!storyId) {
                preview.innerHTML = '<h3>üìã Anteprima Storia</h3><p style="color: #999;">Seleziona una storia...</p>';
                return;
            }
            
            const story = availableStories.find(s => s.id === storyId);
            const fragments = selectedFragments.map(id => {
                const frag = availableFragments.find(f => f.id === id);
                const order = document.getElementById(`order_${id}`)?.value || 0;
                const settingId = document.getElementById(`setting_${id}`)?.value;
                const setting = settingId ? availableSettings.find(s => s.id === settingId) : null;
                return { ...frag, order, setting };
            }).filter(Boolean).sort((a, b) => a.order - b.order);
            
            const characters = selectedCharacters.map(id => availableCharacters.find(c => c.id === id)).filter(Boolean);
            const settings = selectedSettings.map(id => availableSettings.find(s => s.id === id)).filter(Boolean);
            
            let html = '<h3>üìã Anteprima Storia</h3>';
            
            if (story) {
                html += `
                    <div class="preview-section">
                        <strong>üìñ Storia:</strong> ${story.title}
                        <span class="badge badge-age">Et√†: ${story.ageMin}-${story.ageMax}</span>
                    </div>
                `;
            }
            
            if (fragments.length > 0) {
                html += '<div class="preview-section"><strong>üìÑ Sequenza Frammenti:</strong><ul>';
                fragments.forEach(f => {
                    const settingInfo = f.setting ? ` <em style="color: #667eea;">[üìç ${f.setting.name}]</em>` : '';
                    html += `<li><strong>[${f.order}]</strong> ${f.text.substring(0, 50)}...${settingInfo}</li>`;
                });
                html += '</ul></div>';
            }
            
            if (characters.length > 0) {
                html += '<div class="preview-section"><strong>üë§ Personaggi:</strong><ul>';
                characters.forEach(c => {
                    const role = document.getElementById(`role_${c.id}`)?.value || 'personaggio';
                    html += `<li>${c.name} <span class="badge badge-role">${role}</span></li>`;
                });
                html += '</ul></div>';
            }
            
            if (settings.length > 0) {
                html += '<div class="preview-section"><strong>üèûÔ∏è Ambientazioni della Storia:</strong><ul>';
                settings.forEach(s => {
                    const order = document.getElementById(`order_set_${s.id}`)?.value || 0;
                    html += `<li>[${order}] ${s.name} <span style="color: #999;">(${s.type})</span></li>`;
                });
                html += '</ul></div>';
            }
            
            preview.innerHTML = html;
        }

        function buildStory() {
            const storyId = document.getElementById('builderStorySelect').value;
            
            if (!storyId) {
                addLog('Seleziona una storia!', 'error');
                return;
            }
            
            const emotions = document.getElementById('builderEmotions').value
                .split(',')
                .map(e => e.trim())
                .filter(e => e);
            
            const themes = document.getElementById('builderThemes').value
                .split(',')
                .map(t => t.trim())
                .filter(t => t);
            
            const fragmentsData = selectedFragments.map(id => {
                const settingId = document.getElementById(`setting_${id}`)?.value || null;
                return {
                    fragmentId: id,
                    order: parseInt(document.getElementById(`order_${id}`).value) || 0,
                    settingId: settingId
                };
            });
            
            const charactersData = selectedCharacters.map(id => ({
                characterId: id,
                role: document.getElementById(`role_${id}`).value || 'protagonista'
            }));
            
            const settingsData = selectedSettings.map(id => ({
                settingId: id,
                order: parseInt(document.getElementById(`order_set_${id}`).value) || 0
            }));
            
            const data = {
                storyId,
                fragments: fragmentsData,
                characters: charactersData,
                settings: settingsData,
                emotions,
                themes
            };
            
            sendMessage('build_story', data);
            addLog('Costruzione storia in corso...', 'info');
        }

        function resetBuilder() {
            selectedFragments = [];
            selectedCharacters = [];
            selectedSettings = [];
            document.getElementById('builderStorySelect').value = '';
            document.getElementById('builderEmotions').value = '';
            document.getElementById('builderThemes').value = '';
            document.querySelectorAll('.multi-select-item').forEach(item => {
                item.classList.remove('selected');
                const checkbox = item.querySelector('input[type="checkbox"]');
                if (checkbox) checkbox.checked = false;
            });
            updateBuilderPreview();
            addLog('Builder resettato', 'info');
        }

        // VISUALIZE FUNCTIONS
        function loadStories() {
            sendMessage('list_stories');
            addLog('Caricamento storie...', 'info');
        }

        function displayStoriesList(stories) {
            const container = document.getElementById('storiesList');
            
            if (!stories || stories.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìö</div>
                        <p>Nessuna storia disponibile</p>
                        <p style="font-size: 0.9em;">Crea la tua prima storia usando la sezione "Crea Nodi"</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            stories.forEach(story => {
                const card = document.createElement('div');
                card.className = 'story-card';
                card.innerHTML = `
                    <div class="story-card-header" onclick="toggleStoryDetails('${story.id}')">
                        <div>
                            <div class="story-card-title">${story.title}</div>
                            <span class="badge badge-age">Et√†: ${story.ageMin}-${story.ageMax}</span>
                        </div>
                        <span style="font-size: 1.5em;">‚ñº</span>
                    </div>
                    <div class="story-card-details" id="details_${story.id}">
                        <p style="color: #666; margin-bottom: 15px;">${story.description || 'Nessuna descrizione'}</p>
                        <button class="btn-info btn-small" onclick="loadStoryDetails('${story.id}')">Carica Dettagli Completi</button>
                        <div id="full_details_${story.id}"></div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function toggleStoryDetails(storyId) {
            const details = document.getElementById(`details_${storyId}`);
            details.classList.toggle('expanded');
        }

        function loadStoryDetails(storyId) {
            sendMessage('get_story_complete', { storyId });
        }

function displayStoryDetails(storyData) {
  addLog(`Ricevuti dati per storia: ${storyData?.story?.id || 'ID mancante'}`, 'info');

  if (!storyData || !storyData.story) {
    addLog('Dati storia incompleti o mancanti!', 'error');
    return;
  }

  const storyId = storyData.story.id;
  const container = document.getElementById(`full_details_${storyId}`);

  if (!container) {
    addLog(`Contenitore non trovato: full_details_${storyId}`, 'error');
    return;
  }

  addLog(`Mostro dettagli per "${storyData.story.title}"`, 'success');

  let html = '';

  // Titolo e descrizione storia
  html += `<h3 style="color:#667eea; margin-bottom:15px;">üìñ ${storyData.story.title}</h3>`;
  html += `<p style="margin-bottom:20px; color:#666;">${storyData.story.description || 'Nessuna descrizione disponibile'}</p>`;

  // Frammenti
  if (storyData.fragments && storyData.fragments.length > 0) {
    html += '<div class="detail-section"><h4 style="color:#667eea; margin:15px 0 10px;">üìÑ Frammenti della storia</h4>';
    storyData.fragments.forEach((f, index) => {
      html += `
        <div class="detail-item" style="margin-bottom:15px;">
          <strong style="color:#667eea;">${index + 1}. ${f.id}</strong>
          <span class="badge badge-age">Et√†: ${f.ageMin}-${f.ageMax}</span>
          <span class="badge badge-complexity">${f.complexity || 'media'}</span>
          <span class="badge" style="background:#e8f5e8; color:#2e7d32;">${f.tone || 'neutro'}</span>
          
          <p style="margin:15px 0; padding:15px; background:#f8f9fa; border-left:5px solid #667eea; border-radius:8px; font-style:italic; line-height:1.8; font-size:1.05em;">
            "${f.text || '(testo mancante)'}"
          </p>
          
          ${f.emotions && f.emotions.length > 0 ? 
            `<div style="margin:8px 0;"><strong>üí´ Emozioni:</strong> ${f.emotions.join(', ')}</div>` : ''}
          
          ${f.themes && f.themes.length > 0 ? 
            `<div style="margin:8px 0;"><strong>üí° Temi:</strong> ${f.themes.join(', ')}</div>` : ''}
          
          <small style="color:#999;">Ordine nella storia: ${f.order}</small>
        </div>
      `;
    });
    html += '</div>';
  } else {
    html += '<p style="color:#999; font-style:italic;">Nessun frammento associato a questa storia.</p>';
  }

  // Personaggi
  if (storyData.characters && storyData.characters.length > 0) {
    html += '<div class="detail-section"><h4 style="color:#667eea; margin:20px 0 10px;">üë§ Personaggi</h4>';
    storyData.characters.forEach(c => {
      html += `
        <div class="detail-item" style="margin-bottom:12px;">
          <strong style="color:#667eea;">${c.name || c.id}</strong>
          <span class="badge badge-role">${c.role || 'secondario'}</span><br>
          <em style="color:#555;">${c.description || 'Nessuna descrizione'}</em>
          ${c.traits && c.traits.length > 0 ? 
            `<br><small><strong>Tratti:</strong> ${c.traits.join(', ')}</small>` : ''}
        </div>
      `;
    });
    html += '</div>';
  }

  // Ambientazioni
  if (storyData.settings && storyData.settings.length > 0) {
    html += '<div class="detail-section"><h4 style="color:#667eea; margin:20px 0 10px;">üèûÔ∏è Ambientazioni</h4>';
    storyData.settings.forEach(s => {
      html += `
        <div class="detail-item" style="margin-bottom:12px;">
          <strong style="color:#667eea;">${s.name}</strong> 
          <em style="color:#777;">(${s.type || 'non specificato'})</em><br>
          <span style="color:#555;">${s.description || 'Nessuna descrizione'}</span>
        </div>
      `;
    });
    html += '</div>';
  }

  // Se non c'√® niente
  if (html === '') {
    html = '<p style="color:#999; text-align:center; padding:20px;">Nessun dettaglio disponibile per questa storia.</p>';
  }

  container.innerHTML = html;
}


function importRepertoire() {
  const fileInput = document.getElementById('importFile');
  const logContainer = document.getElementById('importLog');
  
  if (!fileInput.files || fileInput.files.length === 0) {
    addLog('Seleziona un file JSON!', 'error');
    return;
  }

  const file = fileInput.files[0];
  const reader = new FileReader();
  
  reader.onload = async (e) => {
    try {
      const data = JSON.parse(e.target.result);

      logContainer.style.display = 'block';
      logContainer.innerHTML = '';
      addImportLog('Inizio importazione repertorio...', 'info');

      // 1. Crea nodi base
      if (data.stories) {
        for (const story of data.stories) {
          await new Promise(resolve => setTimeout(resolve, 100)); // piccolo delay
          sendMessage('create_story', story);
          addImportLog(`Storia: ${story.title}`);
        }
      }

      if (data.fragments) {
        for (const frag of data.fragments) {
          sendMessage('create_fragment', { ...frag, embedding: [] });
          addImportLog(`Frammento: ${frag.id}`);
        }
      }

      if (data.characters) {
        for (const char of data.characters) {
          sendMessage('create_character', char);
          addImportLog(`Personaggio: ${char.name}`);
        }
      }

      if (data.settings) {
        for (const setting of data.settings) {
          sendMessage('create_setting', setting);
          addImportLog(`Ambientazione: ${setting.name}`);
        }
      }

      // 2. Costruisci connessioni (dopo aver creato tutti i nodi)
      if (data.connections) {
        for (const conn of data.connections) {
          sendMessage('build_story', conn);
          addImportLog(`Collegamenti per storia: ${conn.storyId}`);
        }
      }

      addImportLog('‚úÖ Importazione completata con successo!', 'success');

    } catch (err) {
      addImportLog(`Errore: ${err.message}`, 'error');
      console.error(err);
    }
  };

  reader.readAsText(file);
}

function addImportLog(message, type = 'info') {
  const logContainer = document.getElementById('importLog');
  const entry = document.createElement('div');
  entry.className = `log-entry ${type}`;
  entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
  logContainer.appendChild(entry);
  logContainer.scrollTop = logContainer.scrollHeight;
}

function generateStory() {
  const prompt = document.getElementById('genPrompt').value.trim();
  const age = parseInt(document.getElementById('genAge').value);
  const button = document.getElementById('generateBtn');

  if (!prompt) {
    addLog('Scrivi cosa vuoi nella storia!', 'error');
    return;
  }

  // Feedback visivo
  button.disabled = true;
  button.innerHTML = '‚è≥ Il Bardo sta creando la favola...';
  document.getElementById('generatedStory').innerHTML = `
    <p style="text-align:center; color:#667eea; font-style:italic;">
      Il Piccolo Bardo sta pensando alla tua storia magica...<br><br>
      <small>Attendi qualche secondo ‚ú®</small>
    </p>
  `;

  sendMessage('generate_story', { userPrompt: prompt, age });
}

function resetGenerateTab() {
  document.getElementById('genPrompt').value = '';
  document.getElementById('genAge').value = '5';
  document.getElementById('generatedStory').innerHTML = `
    <p style="color: #999; text-align: center; font-style: italic;">
      Scrivi la tua idea e premi "Crea la mia favola"...
    </p>
  `;
  document.getElementById('generateBtn').disabled = false;
  document.getElementById('generateBtn').innerHTML = '‚ú® Crea la mia favola!';
}


        // Connetti all'avvio
        window.addEventListener('load', () => {
            connect();
        });
        
        
        
    </script>
</body>
</html>
